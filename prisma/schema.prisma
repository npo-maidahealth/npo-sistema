// Copie tudo a partir daqui para dentro do seu arquivo schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                      Int                 @id @default(autoincrement())
  nome                    String
  email                   String              @unique
  senha_hash              String?
  whatsapp                String?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt // Removi o @default(now()) que era redundante com @updatedAt
  status                  UserStatus          @default(PENDENTE)
  regional_id             Int?

  cargos                  CargosDoUsuario[]   // Relação correta com a tabela de ligação
  produtos                ProdutosDoUsuario[]

  prioridadesSolicitadas  Prioridade[]        @relation("PrioridadeSolicitada")
  protocolos_responsaveis Protocolo[]         @relation("Responsavel")
  protocolos_solicitados  Protocolo[]         @relation("Solicitante")
  tratativas              Tratativa[]
  regional                Regional?           @relation(fields: [regional_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Cargo {
  id        Int               @id @default(autoincrement())
  nome      String            @unique
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt // Removi o @default(now())
  usuarios  CargosDoUsuario[]
}

// Tabela de ligação para a relação Muitos-para-Muitos entre Usuario e Cargo
model CargosDoUsuario {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  cargoId   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // Removi o @default(now())
  cargo     Cargo    @relation(fields: [cargoId], references: [id])
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])

  @@unique([usuarioId, cargoId])
}

model Protocolo {
  id                    Int         @id @default(autoincrement())
  protocolo_uid         String      @unique
  descricao             String
  tipo_automacao        String
  status                String
  nivel_dificuldade     Int?
  ferramentas_indicadas String?
  data_criacao          DateTime    @default(now())
  data_fechamento       DateTime?
  id_solicitante        Int
  id_responsavel        Int?
  descricao_resolucao   String?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt // Removi o @default(now())
  responsavel           Usuario?    @relation("Responsavel", fields: [id_responsavel], references: [id])
  solicitante           Usuario     @relation("Solicitante", fields: [id_solicitante], references: [id])
  tratativas            Tratativa[]
}

model Tratativa {
  id            Int      @id @default(autoincrement())
  id_protocolo  Int
  id_usuario    Int
  descricao     String
  data_criacao  DateTime @default(now())
  tipo_mensagem String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt // Removi o @default(now())
  protocolo     Protocolo @relation(fields: [id_protocolo], references: [id])
  usuario       Usuario   @relation(fields: [id_usuario], references: [id])
}

model Produto {
  id          Int                 @id @default(autoincrement())
  nome        String              @unique
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt // Removi o @default(now())
  prioridades Prioridade[]
  usuarios    ProdutosDoUsuario[]
}

model ProdutosDoUsuario {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  produtoId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // Removi o @default(now())
  produto   Produto  @relation(fields: [produtoId], references: [id])
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])

  @@unique([usuarioId, produtoId])
}

model Prioridade {
  id                     Int         @id @default(autoincrement())
  numeroGuia             String
  idGuiaECO              Int?
  tipoGuia               String
  status                 String
  caracterAtendimento    String?
  observacao             String?
  produtoId              Int
  usuarioId              Int
  reguladorId            Int?
  dataCriacao            DateTime    @default(now())
  dataAtualizacao        DateTime?   @updatedAt
  capturada              Boolean     @default(false)
  vencimento             DateTime?
  autorizada             Boolean     @default(false)
  regulada               Boolean     @default(false)
  area                   String?
  atrasada               Boolean?
  atrasoRegulacao        String?
  beneficiario           String?
  beneficiarioNomeSocial String?
  cartaoBeneficiario     String?
  cpfBeneficiario        String?
  dataHoraSolicitacao    DateTime?
  dataPausaSla           DateTime?
  dataRegulacao          DateTime?
  dataSolicitacao        DateTime?
  dataVencimentoSla      DateTime?
  fila                   String?
  fonte                  String?     @default("ECO")
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt // Removi o @default(now())
  vezesSolicitado        Int?        @default(1)
  produto                Produto     @relation(fields: [produtoId], references: [id])
  historicoSolicitacoes  SolicitacaoPrioridade[]
  regulador              Regulador?  @relation("PrioridadeRegulador", fields: [reguladorId], references: [id])
  usuario                Usuario     @relation("PrioridadeSolicitada", fields: [usuarioId], references: [id])
}

model Regulador {
  id               Int                @id @default(autoincrement())
  nome             String             @unique
  ativo            Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt // Removi o @default(now())
  Escala_Regulacao Escala_Regulacao[]
  prioridades      Prioridade[]       @relation("PrioridadeRegulador")
  solicitacoesAtendidas SolicitacaoPrioridade[] @relation("ReguladorPlantao")
}
model SolicitacaoPrioridade {
  id                    Int       @id @default(autoincrement())

  prioridadeId          Int       
  prioridade            Prioridade @relation(fields: [prioridadeId], references: [id])
  reguladorPlantaoId    Int?      
  reguladorPlantao      Regulador? @relation("ReguladorPlantao", fields: [reguladorPlantaoId], references: [id])

  dataHoraSolicitacao   DateTime  @default(now())

  observacaoSolicitacao String?

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}
model Escala_Regulacao {
  id          Int       @id(map: "Escala_pkey") @default(autoincrement())
  reguladorId Int
  diaSemana   Int
  turno       String
  horaInicio  String
  horaFim     String
  filas       String
  observacao  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Regulador   Regulador @relation(fields: [reguladorId], references: [id], map: "Escala_reguladorId_fkey")

  @@unique([reguladorId, diaSemana, turno], map: "Escala_reguladorId_diaSemana_turno_key")
}

model Regional {
  id      Int       @id @default(autoincrement())
  nome    String    @db.VarChar(50)
  Usuario Usuario[]
}

model user_sessions {
  sid    String   @id @db.VarChar
  sess   Json     @db.Json
  expire DateTime @db.Timestamp(6)

  @@index([expire], map: "IDX_user_sessions_expire")
}

enum UserStatus {
  PENDENTE
  ATIVO
  INATIVO
}